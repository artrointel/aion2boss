<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Shared Dashboard</title>
    <style>
        body {
            background-color: #313338; /* ë””ìŠ¤ì½”ë“œ ë‹¤í¬ í…Œë§ˆ ë°°ê²½ìƒ‰ */
            color: #dbdee1;
            font-family: 'gg sans', 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container { max-width: 600px; width: 100%; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: #2b2d31;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h2 { margin-top: 0; color: #f2f3f5; border-bottom: 2px solid #3f4147; padding-bottom: 10px; }
        
        /* íƒ€ì´ë¨¸ */
        #timer-box { text-align: center; }
        #timer-display { font-size: 3rem; font-weight: bold; font-variant-numeric: tabular-nums; color: #f2f3f5; margin: 10px 0; }
        .timer-warning { color: #f23f42 !important; animation: blink 1s infinite; }
        
        /* ë²„íŠ¼ */
        button {
            background-color: #5865F2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #4752c4; }
        button:active { transform: translateY(1px); }
        .btn-danger { background-color: #da373c; }
        .btn-danger:hover { background-color: #a1282c; }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #3f4147; }
        th { color: #b5bac1; font-size: 0.9em; text-transform: uppercase; }
        
        /* ì…ë ¥ í¼ */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input {
            background-color: #1e1f22;
            border: 1px solid #1e1f22;
            color: white;
            padding: 10px;
            border-radius: 4px;
            flex-grow: 1;
        }
        input:focus { outline: 2px solid #00a8fc; }

        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <div class="card" id="timer-box">
        <h2>â±ï¸ ê³µìš© íƒ€ì´ë¨¸</h2>
        <div id="timer-display">00:00</div>
        <div style="display: flex; justify-content: center; gap: 10px;">
            <button id="btn-timer-1m">1ë¶„ ì‹œì‘</button>
            <button id="btn-timer-5m">5ë¶„ ì‹œì‘</button>
            <button id="btn-timer-reset" class="btn-danger">ë¦¬ì…‹</button>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“‹ ì„œë²„ ë©¤ë²„ í˜„í™©</h2>
        <div class="input-group">
            <input type="text" id="input-name" placeholder="ë‹‰ë„¤ì„">
            <input type="text" id="input-status" placeholder="ìƒíƒœ (ì˜ˆ: ì¤€ë¹„ì™„ë£Œ)">
            <button id="btn-add">ë“±ë¡/ìˆ˜ì •</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ìƒíƒœ</th>
                    <th style="width: 80px;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // â–¼â–¼â–¼â–¼â–¼â–¼â–¼ [ìˆ˜ì • í•„ìš”] ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš” â–¼â–¼â–¼â–¼â–¼â–¼â–¼
    const firebaseConfig = {
        apiKey: "AIzaSyB8HvxU7VhR9mWiSvyFu3XXXbmLfoKz9M0",
        authDomain: "aion2boss.firebaseapp.com",
        databaseURL: "https://aion2boss-default-rtdb.firebaseio.com",
        projectId: "aion2boss",
        storageBucket: "aion2boss.firebasestorage.app",
        messagingSenderId: "985334026286",
        appId: "1:985334026286:web:4959921d864700b5cf0fbf"
    };

    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ ì„¤ì • (í•˜ë‚˜ì˜ ë°©ì„ ê³µìœ )
    const ROOM_ID = 'lobby_01'; 
    const timerRef = ref(db, `${ROOM_ID}/timer`);
    const usersRef = ref(db, `${ROOM_ID}/users`);

    let localEndTime = 0;
    let timerInterval = null;

    // ==========================================
    // 1. ë°ì´í„° ìˆ˜ì‹  (Listening)
    // ==========================================

    // íƒ€ì´ë¨¸ ë°ì´í„° ê°ì§€
    onValue(timerRef, (snapshot) => {
        const data = snapshot.val();
        if (data && data.endTime) {
            localEndTime = data.endTime;
            updateTimerDisplay(); // ì¦‰ì‹œ ê°±ì‹ 
            if (!timerInterval) startLocalInterval(); // ì¸í„°ë²Œì´ ì—†ìœ¼ë©´ ì‹œì‘
        } else {
            localEndTime = 0;
            document.getElementById('timer-display').innerText = "00:00";
            document.getElementById('timer-display').classList.remove('timer-warning');
        }
    });

    // í…Œì´ë¸” ë°ì´í„° ê°ì§€
    onValue(usersRef, (snapshot) => {
        const data = snapshot.val() || {};
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = ''; // ì´ˆê¸°í™”

        Object.entries(data).forEach(([key, user]) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight: bold; color: white;">${user.name}</td>
                <td>${user.status}</td>
                <td><button class="btn-del" data-key="${key}" style="padding: 5px 10px; font-size: 0.8em; background-color: #3f4147;">ì‚­ì œ</button></td>
            `;
            tbody.appendChild(tr);
        });

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.querySelectorAll('.btn-del').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.target.getAttribute('data-key');
                remove(ref(db, `${ROOM_ID}/users/${key}`));
            });
        });
    });

    // ==========================================
    // 2. íƒ€ì´ë¨¸ ë¡œì§ (Client Side)
    // ==========================================
    function startLocalInterval() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimerDisplay, 100); // 0.1ì´ˆë§ˆë‹¤ ê°±ì‹ 
    }

    function updateTimerDisplay() {
        if (localEndTime === 0) return;
        
        const now = Date.now();
        const diff = localEndTime - now;

        const display = document.getElementById('timer-display');

        if (diff <= 0) {
            display.innerText = "ì‹œê°„ ì¢…ë£Œ!";
            display.classList.add('timer-warning');
            return;
        }

        // ë¶„:ì´ˆ ê³„ì‚°
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        // ë°€ë¦¬ì´ˆ (ì„ íƒì‚¬í•­, ìƒë™ê°ì„ ìœ„í•´)
        const ms = Math.floor((diff % 1000) / 10); 

        display.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        
        // 1ë¶„ ë¯¸ë§Œì¼ ë•Œ ë¹¨ê°„ìƒ‰ ê²½ê³  íš¨ê³¼
        if (diff < 60000) display.classList.add('timer-warning');
        else display.classList.remove('timer-warning');
    }

    // ==========================================
    // 3. ì‚¬ìš©ì í–‰ë™ ì²˜ë¦¬ (Sending)
    // ==========================================

    // íƒ€ì´ë¨¸ ì‹œì‘ í•¨ìˆ˜
    function setTimer(minutes) {
        const endTime = Date.now() + (minutes * 60 * 1000);
        set(timerRef, { endTime: endTime, duration: minutes });
    }

    document.getElementById('btn-timer-1m').addEventListener('click', () => setTimer(1));
    document.getElementById('btn-timer-5m').addEventListener('click', () => setTimer(5));
    document.getElementById('btn-timer-reset').addEventListener('click', () => {
        set(timerRef, null); // íƒ€ì´ë¨¸ ë°ì´í„° ì‚­ì œ
    });

    // í…Œì´ë¸” ë°ì´í„° ì¶”ê°€
    document.getElementById('btn-add').addEventListener('click', () => {
        const name = document.getElementById('input-name').value;
        const status = document.getElementById('input-status').value;
        if (!name) return alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        // ë‹‰ë„¤ì„ì„ í‚¤ê°’ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ì¤‘ë³µ ë°©ì§€ (ë®ì–´ì“°ê¸°)
        // ì‹¤ì œë¡œëŠ” ìœ ì € IDë¥¼ ì“°ëŠ”ê²Œ ì¢‹ì§€ë§Œ ê°„í¸í•¨ì„ ìœ„í•´ ì´ë¦„ ì‚¬ìš©
        set(ref(db, `${ROOM_ID}/users/${name}`), {
            name: name,
            status: status,
            updatedAt: Date.now()
        });
        
        document.getElementById('input-status').value = ''; // ìƒíƒœì°½ë§Œ ë¹„ìš°ê¸°
    });
</script>

</body>
</html>